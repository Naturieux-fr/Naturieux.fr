name: Quality Issues Creator

on:
  push:
    branches: [main]
  schedule:
    # Run every Monday at 9am
    - cron: '0 9 * * 1'
  workflow_dispatch:

env:
  GO_VERSION: '1.22'

permissions:
  issues: write
  contents: read

jobs:
  analyze-and-create-issues:
    name: Analyze & Create Issues
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      # Coverage Analysis
      - name: Run tests with coverage
        run: |
          go test ./... -coverprofile=coverage.out -covermode=atomic 2>&1 | tee test-output.txt
          go tool cover -func=coverage.out > coverage-report.txt

      # Static Analysis
      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin latest

      - name: Run golangci-lint
        continue-on-error: true
        run: |
          golangci-lint run --out-format=json > lint-report.json || true

      # Security Analysis
      - name: Install gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest

      - name: Run gosec
        continue-on-error: true
        run: |
          gosec -fmt=json -out=gosec-report.json ./... || true

      # Vulnerability Check
      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck
        continue-on-error: true
        run: |
          govulncheck -json ./... > vuln-report.json 2>&1 || true

      # Create Issues
      - name: Create coverage issues
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read coverage report
            const coverageReport = fs.readFileSync('coverage-report.txt', 'utf8');
            const lines = coverageReport.split('\n');

            // Parse coverage per package
            const lowCoveragePackages = [];
            for (const line of lines) {
              const match = line.match(/^(.+?)\s+(\d+\.\d+)%$/);
              if (match && match[1] !== 'total:') {
                const pkg = match[1].trim();
                const coverage = parseFloat(match[2]);
                if (coverage < 70 && coverage > 0) {
                  lowCoveragePackages.push({ pkg, coverage });
                }
              }
            }

            // Create issue for low coverage
            if (lowCoveragePackages.length > 0) {
              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'quality,coverage'
              });

              const issueExists = existingIssues.data.some(issue =>
                issue.title.includes('Low Test Coverage')
              );

              if (!issueExists) {
                const body = `## Low Test Coverage Detected

            The following packages have test coverage below 70%:

            | Package | Coverage |
            |---------|----------|
            ${lowCoveragePackages.map(p => `| \`${p.pkg}\` | ${p.coverage}% |`).join('\n')}

            ### Suggested Actions
            - Add unit tests for uncovered code paths
            - Focus on critical business logic first
            - Use table-driven tests for better coverage

            ---
            *Auto-generated by Quality Analysis*`;

                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'ðŸ“Š Low Test Coverage in Multiple Packages',
                  body: body,
                  labels: ['quality', 'coverage', 'automated']
                });
              }
            }

      - name: Create lint issues
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let lintReport;
            try {
              lintReport = JSON.parse(fs.readFileSync('lint-report.json', 'utf8'));
            } catch (e) {
              console.log('No lint issues found');
              return;
            }

            if (!lintReport.Issues || lintReport.Issues.length === 0) {
              console.log('No lint issues');
              return;
            }

            // Group issues by severity/linter
            const criticalIssues = lintReport.Issues.filter(i =>
              ['gosec', 'errcheck', 'staticcheck'].includes(i.FromLinter)
            );

            const codeSmells = lintReport.Issues.filter(i =>
              ['dupl', 'gocyclo', 'gocognit', 'funlen'].includes(i.FromLinter)
            );

            // Create issue for critical problems
            if (criticalIssues.length > 0) {
              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'quality,bug'
              });

              const issueExists = existingIssues.data.some(issue =>
                issue.title.includes('Critical Code Issues')
              );

              if (!issueExists) {
                const issuesList = criticalIssues.slice(0, 20).map(issue => {
                  return `- **${issue.FromLinter}**: ${issue.Text}
              - File: \`${issue.Pos.Filename}:${issue.Pos.Line}\``;
                }).join('\n');

                const body = `## Critical Code Issues Detected

            Found ${criticalIssues.length} critical issues that need attention:

            ${issuesList}

            ${criticalIssues.length > 20 ? `\n*...and ${criticalIssues.length - 20} more issues*` : ''}

            ### Priority
            These issues may cause bugs or security vulnerabilities. Please fix them as soon as possible.

            ---
            *Auto-generated by Quality Analysis*`;

                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'ðŸ› Critical Code Issues Found',
                  body: body,
                  labels: ['quality', 'bug', 'automated', 'priority:high']
                });
              }
            }

            // Create issue for code smells
            if (codeSmells.length > 5) {
              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'quality,refactoring'
              });

              const issueExists = existingIssues.data.some(issue =>
                issue.title.includes('Code Complexity')
              );

              if (!issueExists) {
                const smellsList = codeSmells.slice(0, 10).map(issue => {
                  return `- **${issue.FromLinter}**: ${issue.Text}
              - File: \`${issue.Pos.Filename}:${issue.Pos.Line}\``;
                }).join('\n');

                const body = `## Code Complexity Issues

            Found ${codeSmells.length} code smells that should be refactored:

            ${smellsList}

            ${codeSmells.length > 10 ? `\n*...and ${codeSmells.length - 10} more issues*` : ''}

            ### Suggested Actions
            - Break down large functions into smaller ones
            - Reduce cyclomatic complexity
            - Extract duplicated code into shared functions

            ---
            *Auto-generated by Quality Analysis*`;

                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'ðŸ”§ Code Complexity Issues Need Refactoring',
                  body: body,
                  labels: ['quality', 'refactoring', 'automated', 'priority:medium']
                });
              }
            }

      - name: Create security issues
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let secReport;
            try {
              secReport = JSON.parse(fs.readFileSync('gosec-report.json', 'utf8'));
            } catch (e) {
              console.log('No security report found');
              return;
            }

            if (!secReport.Issues || secReport.Issues.length === 0) {
              console.log('No security issues');
              return;
            }

            // Group by severity
            const highSeverity = secReport.Issues.filter(i => i.severity === 'HIGH');
            const mediumSeverity = secReport.Issues.filter(i => i.severity === 'MEDIUM');

            if (highSeverity.length > 0) {
              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'security,priority:critical'
              });

              const issueExists = existingIssues.data.some(issue =>
                issue.title.includes('Security Vulnerabilities')
              );

              if (!issueExists) {
                const issuesList = highSeverity.map(issue => {
                  return `### ${issue.rule_id}: ${issue.details}
            - **Severity**: ${issue.severity}
            - **Confidence**: ${issue.confidence}
            - **File**: \`${issue.file}:${issue.line}\`
            - **Code**: \`${issue.code}\``;
                }).join('\n\n');

                const body = `## ðŸš¨ Security Vulnerabilities Detected

            Found ${highSeverity.length} HIGH severity security issues:

            ${issuesList}

            ### Immediate Actions Required
            - Review and fix these vulnerabilities immediately
            - Do not deploy to production until resolved
            - Consider security review of related code

            ---
            *Auto-generated by Security Analysis*`;

                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'ðŸš¨ Security Vulnerabilities Found - Immediate Action Required',
                  body: body,
                  labels: ['security', 'automated', 'priority:critical']
                });
              }
            }

            if (mediumSeverity.length > 0) {
              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'security,priority:high'
              });

              const issueExists = existingIssues.data.some(issue =>
                issue.title.includes('Security Warnings')
              );

              if (!issueExists) {
                const issuesList = mediumSeverity.slice(0, 10).map(issue => {
                  return `- **${issue.rule_id}**: ${issue.details}
              - File: \`${issue.file}:${issue.line}\``;
                }).join('\n');

                const body = `## âš ï¸ Security Warnings

            Found ${mediumSeverity.length} MEDIUM severity security issues:

            ${issuesList}

            ${mediumSeverity.length > 10 ? `\n*...and ${mediumSeverity.length - 10} more issues*` : ''}

            ### Recommended Actions
            - Review these issues in the next sprint
            - Implement security best practices
            - Add input validation where needed

            ---
            *Auto-generated by Security Analysis*`;

                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'âš ï¸ Security Warnings Need Attention',
                  body: body,
                  labels: ['security', 'automated', 'priority:high']
                });
              }
            }

      - name: Create vulnerability issues
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let vulnReport;
            try {
              const content = fs.readFileSync('vuln-report.json', 'utf8');
              // govulncheck outputs multiple JSON objects, parse line by line
              const lines = content.split('\n').filter(l => l.trim());
              const vulns = [];
              for (const line of lines) {
                try {
                  const obj = JSON.parse(line);
                  if (obj.vulnerability) {
                    vulns.push(obj.vulnerability);
                  }
                } catch (e) {}
              }
              vulnReport = vulns;
            } catch (e) {
              console.log('No vulnerability report found');
              return;
            }

            if (vulnReport.length === 0) {
              console.log('No vulnerabilities found');
              return;
            }

            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,dependencies'
            });

            const issueExists = existingIssues.data.some(issue =>
              issue.title.includes('Vulnerable Dependencies')
            );

            if (!issueExists) {
              const vulnList = vulnReport.slice(0, 10).map(vuln => {
                return `### ${vuln.id || 'Unknown'}
            - **Package**: ${vuln.module_path || 'Unknown'}
            - **Description**: ${vuln.details || 'No details'}`;
              }).join('\n\n');

              const body = `## ðŸ“¦ Vulnerable Dependencies Detected

            Found ${vulnReport.length} known vulnerabilities in dependencies:

            ${vulnList}

            ${vulnReport.length > 10 ? `\n*...and ${vulnReport.length - 10} more vulnerabilities*` : ''}

            ### Recommended Actions
            - Run \`go get -u ./...\` to update dependencies
            - Check for breaking changes before updating
            - Review security advisories for each vulnerability

            ---
            *Auto-generated by Vulnerability Scanner*`;

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ“¦ Vulnerable Dependencies Need Update',
                body: body,
                labels: ['security', 'dependencies', 'automated']
              });
            }
