name: Security Analysis

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run daily at 2am
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  GO_VERSION: '1.22'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  # SAST - Static Application Security Testing
  sast:
    name: SAST Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run gosec
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          gosec -fmt=json -out=gosec-detailed.json ./... || true
          gosec -fmt=text -out=gosec-report.txt ./... || true

      - name: Upload security artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gosec-reports
          path: |
            gosec-detailed.json
            gosec-report.txt

  # SCA - Software Composition Analysis
  sca:
    name: Dependency Security
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck -json ./... > govuln-report.json 2>&1 || true
          govulncheck ./... > govuln-report.txt 2>&1 || true

      - name: Run nancy
        run: |
          go install github.com/sonatype-nexus-community/nancy@latest
          go list -json -deps ./... | nancy sleuth -o json > nancy-report.json 2>&1 || true
          go list -json -deps ./... | nancy sleuth > nancy-report.txt 2>&1 || true

      - name: Upload SCA artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sca-reports
          path: |
            govuln-report.json
            govuln-report.txt
            nancy-report.json
            nancy-report.txt

  # Secret Scanning
  secrets:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run gitleaks
        run: |
          go install github.com/zricethezav/gitleaks/v8@latest
          gitleaks detect --source . --verbose --redact --report-format json --report-path gitleaks-report.json || true
          gitleaks detect --source . --verbose --redact > gitleaks-report.txt 2>&1 || true

      - name: Upload gitleaks report
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-reports
          path: |
            gitleaks-report.json
            gitleaks-report.txt

  # License Compliance
  license:
    name: License Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Check licenses
        run: |
          go install github.com/google/go-licenses@latest
          go-licenses check ./... 2>&1 | tee license-report.txt || true

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: license-report.txt

  # Security Report & Issues
  report:
    name: Security Report
    runs-on: ubuntu-latest
    needs: [sast, sca, secrets, license]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./reports

      - name: Generate security summary
        id: summary
        run: |
          # Count gosec issues
          GOSEC_ISSUES=0
          GOSEC_HIGH=0
          GOSEC_MEDIUM=0
          if [ -f reports/gosec-reports/gosec-detailed.json ]; then
            GOSEC_ISSUES=$(cat reports/gosec-reports/gosec-detailed.json | jq '.Issues | length' 2>/dev/null || echo "0")
            GOSEC_HIGH=$(cat reports/gosec-reports/gosec-detailed.json | jq '[.Issues[] | select(.severity == "HIGH")] | length' 2>/dev/null || echo "0")
            GOSEC_MEDIUM=$(cat reports/gosec-reports/gosec-detailed.json | jq '[.Issues[] | select(.severity == "MEDIUM")] | length' 2>/dev/null || echo "0")
          fi

          # Check govulncheck
          VULN_COUNT=0
          if [ -f reports/sca-reports/govuln-report.txt ]; then
            VULN_COUNT=$(grep -c "Vulnerability" reports/sca-reports/govuln-report.txt 2>/dev/null | head -1 || echo "0")
            VULN_COUNT=${VULN_COUNT:-0}
            [[ "$VULN_COUNT" =~ ^[0-9]+$ ]] || VULN_COUNT=0
          fi

          # Check secrets
          SECRETS_COUNT=0
          if [ -f reports/gitleaks-reports/gitleaks-report.json ]; then
            SECRETS_COUNT=$(cat reports/gitleaks-reports/gitleaks-report.json | jq 'length' 2>/dev/null || echo "0")
            [[ "$SECRETS_COUNT" =~ ^[0-9]+$ ]] || SECRETS_COUNT=0
          fi

          cat << 'EOF' > SECURITY_REPORT.md
          # Security Report

          > Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Summary

          | Category | Issues | Status |
          |----------|--------|--------|
          | SAST (gosec) | GOSEC_ISSUES_PLACEHOLDER | GOSEC_STATUS_PLACEHOLDER |
          | High Severity | GOSEC_HIGH_PLACEHOLDER | HIGH_STATUS_PLACEHOLDER |
          | Medium Severity | GOSEC_MEDIUM_PLACEHOLDER | MEDIUM_STATUS_PLACEHOLDER |
          | Vulnerabilities | VULN_PLACEHOLDER | VULN_STATUS_PLACEHOLDER |
          | Secrets Detected | SECRETS_PLACEHOLDER | SECRETS_STATUS_PLACEHOLDER |

          ## SAST Results (gosec)

          ```
          GOSEC_REPORT_PLACEHOLDER
          ```

          ## Dependency Vulnerabilities

          ```
          VULN_REPORT_PLACEHOLDER
          ```

          ## License Compliance

          ```
          LICENSE_REPORT_PLACEHOLDER
          ```

          ---
          *Generated by Security Analysis workflow*
          EOF

          # Replace placeholders
          sed -i "s/GOSEC_ISSUES_PLACEHOLDER/$GOSEC_ISSUES/g" SECURITY_REPORT.md
          sed -i "s/GOSEC_HIGH_PLACEHOLDER/$GOSEC_HIGH/g" SECURITY_REPORT.md
          sed -i "s/GOSEC_MEDIUM_PLACEHOLDER/$GOSEC_MEDIUM/g" SECURITY_REPORT.md
          sed -i "s/VULN_PLACEHOLDER/$VULN_COUNT/g" SECURITY_REPORT.md
          sed -i "s/SECRETS_PLACEHOLDER/$SECRETS_COUNT/g" SECURITY_REPORT.md

          # Status icons
          [[ "$GOSEC_HIGH" -eq 0 ]] && sed -i 's/GOSEC_STATUS_PLACEHOLDER/âœ…/g' SECURITY_REPORT.md || sed -i 's/GOSEC_STATUS_PLACEHOLDER/âŒ/g' SECURITY_REPORT.md
          [[ "$GOSEC_HIGH" -eq 0 ]] && sed -i 's/HIGH_STATUS_PLACEHOLDER/âœ…/g' SECURITY_REPORT.md || sed -i 's/HIGH_STATUS_PLACEHOLDER/âŒ/g' SECURITY_REPORT.md
          [[ "$GOSEC_MEDIUM" -le 5 ]] && sed -i 's/MEDIUM_STATUS_PLACEHOLDER/âœ…/g' SECURITY_REPORT.md || sed -i 's/MEDIUM_STATUS_PLACEHOLDER/âš ï¸/g' SECURITY_REPORT.md
          [[ "$VULN_COUNT" -eq 0 ]] && sed -i 's/VULN_STATUS_PLACEHOLDER/âœ…/g' SECURITY_REPORT.md || sed -i 's/VULN_STATUS_PLACEHOLDER/âŒ/g' SECURITY_REPORT.md
          [[ "$SECRETS_COUNT" -eq 0 ]] && sed -i 's/SECRETS_STATUS_PLACEHOLDER/âœ…/g' SECURITY_REPORT.md || sed -i 's/SECRETS_STATUS_PLACEHOLDER/âŒ/g' SECURITY_REPORT.md

          # Reports content
          GOSEC_CONTENT=$(cat reports/gosec-reports/gosec-report.txt 2>/dev/null | head -100 || echo "No issues found")
          VULN_CONTENT=$(cat reports/sca-reports/govuln-report.txt 2>/dev/null | head -100 || echo "No vulnerabilities found")
          LICENSE_CONTENT=$(cat reports/license-report/license-report.txt 2>/dev/null | head -50 || echo "All licenses compliant")

          # Use awk to replace multiline content
          awk -v gosec="$GOSEC_CONTENT" '{gsub(/GOSEC_REPORT_PLACEHOLDER/, gosec)}1' SECURITY_REPORT.md > tmp && mv tmp SECURITY_REPORT.md
          awk -v vuln="$VULN_CONTENT" '{gsub(/VULN_REPORT_PLACEHOLDER/, vuln)}1' SECURITY_REPORT.md > tmp && mv tmp SECURITY_REPORT.md
          awk -v lic="$LICENSE_CONTENT" '{gsub(/LICENSE_REPORT_PLACEHOLDER/, lic)}1' SECURITY_REPORT.md > tmp && mv tmp SECURITY_REPORT.md

          echo "gosec_high=$GOSEC_HIGH" >> $GITHUB_OUTPUT
          echo "vuln_count=$VULN_COUNT" >> $GITHUB_OUTPUT
          echo "secrets_count=$SECRETS_COUNT" >> $GITHUB_OUTPUT

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: SECURITY_REPORT.md

      - name: Create security issues
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const gosecHigh = parseInt('${{ steps.summary.outputs.gosec_high }}') || 0;
            const vulnCount = parseInt('${{ steps.summary.outputs.vuln_count }}') || 0;
            const secretsCount = parseInt('${{ steps.summary.outputs.secrets_count }}') || 0;

            const { data: existingIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,automated'
            });

            // High severity security issues
            if (gosecHigh > 0) {
              const hasExisting = existingIssues.some(i => i.title.includes('High Severity Security'));
              if (!hasExisting) {
                let report = '';
                try { report = fs.readFileSync('reports/gosec-reports/gosec-report.txt', 'utf8'); } catch (e) {}

                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'ðŸš¨ High Severity Security Issues Detected',
                  body: `## Security Alert\n\nFound **${gosecHigh}** high-severity security issues.\n\n### Details\n\`\`\`\n${report.substring(0, 3000)}\n\`\`\`\n\n### Required Actions\n1. Review each finding immediately\n2. Fix or document false positives\n3. Do not deploy until resolved\n\n---\n*Auto-generated by Security Analysis*`,
                  labels: ['security', 'automated', 'priority:critical']
                });
              }
            }

            // Dependency vulnerabilities
            if (vulnCount > 0) {
              const hasExisting = existingIssues.some(i => i.title.includes('Dependency Vulnerabilities'));
              if (!hasExisting) {
                let report = '';
                try { report = fs.readFileSync('reports/sca-reports/govuln-report.txt', 'utf8'); } catch (e) {}

                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'ðŸ“¦ Dependency Vulnerabilities Found',
                  body: `## Vulnerability Alert\n\nFound **${vulnCount}** known vulnerabilities in dependencies.\n\n### Details\n\`\`\`\n${report.substring(0, 3000)}\n\`\`\`\n\n### Required Actions\n1. Update affected dependencies\n2. Run \`go get -u ./...\` to update\n3. Review changelog for breaking changes\n\n---\n*Auto-generated by Security Analysis*`,
                  labels: ['security', 'dependencies', 'automated']
                });
              }
            }

            // Secrets detected
            if (secretsCount > 0) {
              const hasExisting = existingIssues.some(i => i.title.includes('Secrets Detected'));
              if (!hasExisting) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'ðŸ”‘ Secrets Detected in Repository',
                  body: `## Critical Security Alert\n\nFound **${secretsCount}** potential secrets in the codebase.\n\n### Required Actions\n1. **Immediately rotate** all detected credentials\n2. Remove secrets from git history using BFG or git filter-branch\n3. Use environment variables or secret managers\n4. Review .gitignore for sensitive files\n\n---\n*Auto-generated by Security Analysis*`,
                  labels: ['security', 'automated', 'priority:critical']
                });
              }
            }

      - name: Commit security report
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add SECURITY_REPORT.md || true
          git diff --staged --quiet || git commit -m "docs: update security report [skip ci]"
          git push || true
